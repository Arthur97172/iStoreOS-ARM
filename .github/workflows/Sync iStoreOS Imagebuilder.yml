name:  ğŸ’¿ Sync iStoreOS Imagebuilder

on:
  schedule:
    - cron: '0 2 * * *' # æ¯å¤©åŒ—äº¬æ—¶é—´ä¸Šåˆ10:00å·¦å³è¿è¡Œ
  workflow_dispatch:      # æ”¯æŒæ‰‹åŠ¨ç‚¹å‡»æ‰§è¡Œ

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get Remote Date and Check Local
        id: process
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          URL="https://fw0.koolcenter.com/iStoreOS/ib/armsr/istoreos-imagebuilder-armsr-armv8.Linux-x86_64.tar.zst"
          
          # 1. ä½¿ç”¨ curl è·å– Headerï¼Œæå– Last-Modified å­—æ®µ
          # ä¾‹å¦‚: Last-Modified: Fri, 20 Dec 2024 08:30:15 GMT
          RAW_DATE=$(curl -sI $URL | grep -i "last-modified" | cut -d':' -f2- | xargs)
          
          if [ -z "$RAW_DATE" ]; then
            echo "é”™è¯¯ï¼šæ— æ³•è·å–è¿œç¨‹æ–‡ä»¶æ—¥æœŸ"
            exit 1
          fi

          # 2. æ ¼å¼åŒ–æ—¥æœŸä¸º YYYYMMDD (ä¾‹å¦‚ 20241220)
          RELEASE_DATE=$(date -d "$RAW_DATE" +%Y%m%d)
          FILENAME="${RELEASE_DATE}-istoreos-imagebuilder-armsr-armv8.Linux-x86_64.tar.zst"
          
          echo "è¿œç¨‹å‘å¸ƒæ—¥æœŸ: $RELEASE_DATE"
          echo "å‡†å¤‡æ–‡ä»¶å: $FILENAME"

          # 3. æ£€æŸ¥ GitHub ä¸Šæ˜¯å¦å·²å­˜åœ¨æ­¤æ—¥æœŸçš„æ–‡ä»¶
          # æ³¨æ„ï¼šè¿™é‡Œä¼šæ£€æŸ¥åä¸º iStoreOS-Imagebuilder çš„ Release
          EXISTS=$(gh release view iStoreOS-Imagebuilder --json assets --jq ".assets[].name" | grep -w "$FILENAME" || true)

          if [ "$EXISTS" = "$FILENAME" ]; then
            echo "skip_upload=true" >> $GITHUB_OUTPUT
            echo "æ£€æµ‹åˆ°ç›¸åŒæ—¥æœŸçš„æ–‡ä»¶å·²å­˜åœ¨ï¼Œè·³è¿‡æœ¬æ¬¡ä»»åŠ¡ã€‚"
          else
            echo "skip_upload=false" >> $GITHUB_OUTPUT
            echo "filename=$FILENAME" >> $GITHUB_OUTPUT
            echo "url=$URL" >> $GITHUB_OUTPUT
          fi

      - name: Download and Rename
        if: steps.process.outputs.skip_upload == 'false'
        run: |
          curl -L ${{ steps.process.outputs.url }} -o ${{ steps.process.outputs.filename }}

      - name: Upload to Release
        if: steps.process.outputs.skip_upload == 'false'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: iStoreOS-Imagebuilder
          files: ${{ steps.process.outputs.filename }}
          body: "è‡ªåŠ¨åŒæ­¥ iStoreOS Imagebuilderã€‚å†å²ç‰ˆæœ¬ä¼šåœ¨æ­¤æŒç»­ç´¯ç§¯ã€‚"
          # ç¡®ä¿ä¸ä¼šå› ä¸º Release ä¸å­˜åœ¨è€ŒæŠ¥é”™ï¼Œå®ƒä¼šè‡ªåŠ¨åˆ›å»ºä¸€ä¸ª
          make_latest: true 
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
