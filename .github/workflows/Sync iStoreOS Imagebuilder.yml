name:  ğŸ’¿ Sync iStoreOS Imagebuilder

on:
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Parse Remote Page for Date
        id: parse
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          BASE_URL="https://fw0.koolcenter.com/iStoreOS/ib/armsr/"
          TARGET_FILE="istoreos-imagebuilder-armsr-armv8.Linux-x86_64.tar.zst"
          
          # ä¸‹è½½æºç å¹¶æŸ¥æ‰¾ç›®æ ‡æ–‡ä»¶æ‰€åœ¨çš„è¡Œ
          LINE_CONTENT=$(curl -sL $BASE_URL | grep "$TARGET_FILE" | head -n 1)
          
          # æå–è¯¥è¡Œä¸­çš„æ—¥æœŸå­—ç¬¦ä¸²
          # è¿™é‡Œçš„é€»è¾‘æ˜¯å¯»æ‰¾ 202x å¼€å¤´çš„æ—¥æœŸï¼Œæˆ–è€…åŒ…å«æ¨ªæ /å†’å·çš„æ—¶é—´å­—ç¬¦ä¸²
          RAW_DATE=$(echo "$LINE_CONTENT" | grep -oE '[0-9]{4}-[0-9]{2}-[0-9]{2}' || echo "")
          
          # å¦‚æœä¸Šé¢æ²¡åŒ¹é…åˆ°ï¼Œå°è¯•åŒ¹é…ç½‘é¡µå¸¸è§çš„ 26-Dec-2024 è¿™ç§æ ¼å¼
          if [ -z "$RAW_DATE" ]; then
             RAW_DATE=$(echo "$LINE_CONTENT" | grep -oE '[0-9]{2}-[A-Za-z]{3}-[0-9]{4}' || echo "")
          fi

          if [ -z "$RAW_DATE" ]; then
            echo "--- è°ƒè¯•ä¿¡æ¯ï¼šè¾“å‡ºè¯¥è¡Œæºç  ---"
            echo "$LINE_CONTENT"
            echo "é”™è¯¯ï¼šæ— æ³•åœ¨é¡µé¢è¡Œå†…è¯†åˆ«æ—¥æœŸæ ¼å¼"
            exit 1
          fi

          # ç»Ÿä¸€è½¬æ¢ä¸º YYYYMMDD
          RELEASE_DATE=$(date -d "$RAW_DATE" +%Y%m%d)
          FILENAME="${RELEASE_DATE}-${TARGET_FILE}"
          
          echo "Parsed Date: $RELEASE_DATE"
          echo "Target Filename: $FILENAME"

          # æ£€æŸ¥æ˜¯å¦å­˜åœ¨ (ç”±äºä½ çš„ Tag æ˜¯ iStoreOS-Imagebuilder)
          # æ³¨æ„ï¼šå¦‚æœç¬¬ä¸€æ¬¡è¿è¡Œï¼ŒRelease å¯èƒ½ä¸å­˜åœ¨ï¼ŒåŠ  || true å®¹é”™
          EXISTS=$(gh release view iStoreOS-Imagebuilder --json assets --jq ".assets[].name" 2>/dev/null | grep -w "$FILENAME" || true)

          if [ "$EXISTS" = "$FILENAME" ]; then
            echo "skip_upload=true" >> $GITHUB_OUTPUT
          else
            echo "skip_upload=false" >> $GITHUB_OUTPUT
            echo "filename=$FILENAME" >> $GITHUB_OUTPUT
            echo "url=${BASE_URL}${TARGET_FILE}" >> $GITHUB_OUTPUT
          fi
          
      - name: Download and Upload
        if: steps.parse.outputs.skip_upload == 'false'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: iStoreOS-Imagebuilder
          files: |
            ${{ steps.parse.outputs.filename }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        # æ³¨æ„ï¼šè¿™é‡Œéœ€è¦å…ˆä¸‹è½½å†ä¸Šä¼ ï¼Œsoftprops æ’ä»¶æ”¯æŒç›´æ¥ä¼ æœ¬åœ°æ–‡ä»¶
        # æˆ‘ä»¬åœ¨ä¸‹é¢å¢åŠ ä¸€ä¸ªä¸‹è½½æ­¥éª¤
        
      - name: Exec Download
        if: steps.parse.outputs.skip_upload == 'false'
        run: |
          curl -L ${{ steps.parse.outputs.url }} -o ${{ steps.parse.outputs.filename }}
          # é‡æ–°è§¦å‘ä¸Šä¼ é€»è¾‘ï¼ˆæˆ–è€…æ•´åˆåˆ°ä¸Šä¸€æ­¥ï¼‰
          gh release upload iStoreOS-Imagebuilder ${{ steps.parse.outputs.filename }} --clobber
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
