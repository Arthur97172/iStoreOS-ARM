name:  ğŸ’¿ Sync iStoreOS Imagebuilder

on:
  schedule:
    - cron: '0 2 * * *' # æ¯å¤©å®šæ—¶è¿è¡Œ
  workflow_dispatch:      # æ”¯æŒæ‰‹åŠ¨è§¦å‘

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Parse Remote Page for Date
        id: parse
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          BASE_URL="https://fw0.koolcenter.com/iStoreOS/ib/armsr/"
          TARGET_FILE="istoreos-imagebuilder-armsr-armv8.Linux-x86_64.tar.zst"
          
          # 1. ä¸‹è½½ç½‘é¡µæºä»£ç å¹¶æå–å¯¹åº”æ–‡ä»¶çš„æ—¥æœŸè¡Œ
          # é€»è¾‘ï¼šåŒ¹é…æ–‡ä»¶åï¼Œå¹¶æå–å®ƒå‰åçš„ YYYY-MM-DD æ ¼å¼æ—¥æœŸ
          PAGE_CONTENT=$(curl -s $BASE_URL)
          
          # ä½¿ç”¨ grep åŒ¹é…æ–‡ä»¶åæ‰€åœ¨çš„è¡Œï¼Œå¹¶æå– 202x-xx-xx æ ¼å¼çš„æ—¥æœŸ
          RAW_DATE=$(echo "$PAGE_CONTENT" | grep "$TARGET_FILE" | grep -oP '\d{4}-\d{2}-\d{2}' | head -n 1)
          
          if [ -z "$RAW_DATE" ]; then
            echo "é”™è¯¯ï¼šæ— æ³•åœ¨é¡µé¢ä¸Šæ‰¾åˆ°æ–‡ä»¶æ—¥æœŸ"
            exit 1
          fi

          # 2. å»æ‰æ—¥æœŸä¸­çš„æ¨ªæ ï¼Œè½¬æ¢æˆ YYYYMMDD
          RELEASE_DATE=$(echo "$RAW_DATE" | sed 's/-//g')
          FILENAME="${RELEASE_DATE}-${TARGET_FILE}"
          
          echo "Parsed Date: $RELEASE_DATE"
          echo "Target Filename: $FILENAME"

          # 3. æ£€æŸ¥ GitHub Release æ˜¯å¦å·²å­˜åœ¨
          EXISTS=$(gh release view iStoreOS-Imagebuilder --json assets --jq ".assets[].name" | grep -w "$FILENAME" || true)

          if [ "$EXISTS" = "$FILENAME" ]; then
            echo "skip_upload=true" >> $GITHUB_OUTPUT
            echo "æ–‡ä»¶ $FILENAME å·²å­˜åœ¨ï¼Œè·³è¿‡ã€‚"
          else
            echo "skip_upload=false" >> $GITHUB_OUTPUT
            echo "filename=$FILENAME" >> $GITHUB_OUTPUT
            echo "url=${BASE_URL}${TARGET_FILE}" >> $GITHUB_OUTPUT
          fi

      - name: Download and Upload
        if: steps.parse.outputs.skip_upload == 'false'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: iStoreOS-Imagebuilder
          files: |
            ${{ steps.parse.outputs.filename }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        # æ³¨æ„ï¼šè¿™é‡Œéœ€è¦å…ˆä¸‹è½½å†ä¸Šä¼ ï¼Œsoftprops æ’ä»¶æ”¯æŒç›´æ¥ä¼ æœ¬åœ°æ–‡ä»¶
        # æˆ‘ä»¬åœ¨ä¸‹é¢å¢åŠ ä¸€ä¸ªä¸‹è½½æ­¥éª¤
        
      - name: Exec Download
        if: steps.parse.outputs.skip_upload == 'false'
        run: |
          curl -L ${{ steps.parse.outputs.url }} -o ${{ steps.parse.outputs.filename }}
          # é‡æ–°è§¦å‘ä¸Šä¼ é€»è¾‘ï¼ˆæˆ–è€…æ•´åˆåˆ°ä¸Šä¸€æ­¥ï¼‰
          gh release upload iStoreOS-Imagebuilder ${{ steps.parse.outputs.filename }} --clobber
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
