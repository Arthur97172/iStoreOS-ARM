name:  ğŸ’¿ Sync iStoreOS Imagebuilder

on:
  schedule:
    - cron: '0 2 * * *' # æ¯å¤©å‡Œæ™¨ 2:00 è¿è¡Œï¼ˆé¿å¼€é«˜å³°ï¼‰
  workflow_dispatch:      # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write # å¿…é¡»èµ‹äºˆå†™å…¥æƒé™ä»¥æ›´æ–° Release

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check Remote and Local Version
        id: check
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          URL="https://fw0.koolcenter.com/iStoreOS/ib/armsr/istoreos-imagebuilder-armsr-armv8.Linux-x86_64.tar.zst"
          
          # 1. è·å–è¿œç¨‹æ–‡ä»¶æ—¥æœŸ
          LAST_MODIFIED=$(curl -sI $URL | grep -i "last-modified" | cut -d':' -f2- | xargs)
          RELEASE_DATE=$(date -d "$LAST_MODIFIED" +%Y%m%d)
          FILENAME="${RELEASE_DATE}-istoreos-imagebuilder-armsr-armv8.Linux-x86_64.tar.zst"
          
          echo "Remote file date: $RELEASE_DATE"
          echo "Target filename: $FILENAME"

          # 2. æ£€æŸ¥ GitHub Release ä¸­æ˜¯å¦å·²å­˜åœ¨è¯¥æ–‡ä»¶
          # åˆ—å‡ºè¯¥ tag ä¸‹çš„æ‰€æœ‰æ–‡ä»¶åï¼Œå¹¶æœç´¢æ˜¯å¦å­˜åœ¨å½“å‰æ–‡ä»¶å
          EXISTS=$(gh release view iStoreOS-Imagebuilder --json assets --jq ".assets[].name" | grep -w "$FILENAME" || true)

          if [ "$EXISTS" = "$FILENAME" ]; then
            echo "status=skip" >> $GITHUB_OUTPUT
            echo "File $FILENAME already exists. Skipping upload."
          else
            echo "status=download" >> $GITHUB_OUTPUT
            echo "filename=$FILENAME" >> $GITHUB_OUTPUT
            echo "url=$URL" >> $GITHUB_OUTPUT
          fi

      - name: Download File
        if: steps.check.outputs.status == 'download'
        run: |
          curl -L ${{ steps.check.outputs.url }} -o ${{ steps.check.outputs.filename }}

      - name: Upload to GitHub Release
        if: steps.check.outputs.status == 'download'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: iStoreOS-Imagebuilder
          files: ${{ steps.check.outputs.filename }}
          # append_body: true # å¯é€‰ï¼šæ˜¯å¦åœ¨ Release è¯´æ˜ä¸­è¿½åŠ ä¿¡æ¯
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
