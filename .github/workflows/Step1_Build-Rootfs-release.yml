name: ğŸ’¿ Step1_Build-Rootfs-release

on:
  workflow_dispatch:
    inputs:
      build_version:
        description: "è¯·é€‰æ‹©æ„å»ºç‰ˆæœ¬ (latest ä¸ºå®˜ç½‘æœ€æ–°)"
        required: true
        default: 'latest'
        type: choice
        options:
          - 'latest'
          - '20251205'
          - '20251128'
          - '20251121'
      luci_version:
        description: "é€‰æ‹©luciç‰ˆæœ¬"
        required: true
        default: "24.10.4"
        type: choice
        options:
          - '24.10.0'
          - '24.10.1'
          - '24.10.2'
          - '24.10.3'
          - '24.10.4' 
      network_settings:
        description: "è¯·é€‰æ‹©åˆå§‹ç½‘ç»œé…ç½®"
        required: true
        default: 'static'
        type: choice
        options:
          - 'static'
          - 'dhcp'
      ipaddr:
        description: 'è¯·è¾“å…¥ç®¡ç†IP'
        required: true
        default: '192.168.10.1'
      gateway:
        description: 'è¯·è¾“å…¥é»˜è®¤ç½‘å…³'
        required: true
        default: '192.168.10.1'

env:
  VERSION: ${{ inputs.luci_version }}

jobs:
  build:
    runs-on: ubuntu-22.04
    # å…³é”®ï¼šæ·»åŠ å†™å…¥æƒé™ï¼Œè§£å†³ 403 æŠ¥é”™
    permissions:
      contents: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: âš™ï¸ è®¾ç½®å¯æ‰§è¡Œæƒé™
      run: | 
        chmod +x arm64/build_config.sh
        chmod +x shell/*.sh

    - name: âš™ï¸ è®¾ç½®IPã€ç½‘å…³å’Œç‰ˆæœ¬å·
      run: |
        CONFIG_PATH="./files/etc/uci-defaults/99-custom.sh"
        echo "å½“å‰ç½‘ç»œé…ç½®è·¯å¾„: $CONFIG_PATH"
        
        # 1. æ›¿æ¢ç‰ˆæœ¬å·å ä½ç¬¦
        sed -i "s/ç‰ˆæœ¬å·/${{ env.VERSION }}/g" "$CONFIG_PATH"
        [ -f "./files/etc/banner" ] && sed -i "s/ç‰ˆæœ¬å·/${{ env.VERSION }}/g" "./files/etc/banner"

        # 2. ç½‘ç»œé€»è¾‘é…ç½® (å…³é”®ä¿®æ”¹ç‚¹ï¼šä¸å†åˆ é™¤è¡Œï¼Œæ”¹ç”¨å…³é”®è¯æ›¿æ¢)
        if [ "${{ inputs.network_settings }}" = "static" ]; then
           echo "æ¨¡å¼ï¼šé™æ€IP (æ—è·¯ç”±)"
           # å°†è„šæœ¬å†…é»˜è®¤çš„ 192.168.10.1 æ›¿æ¢ä¸ºç”¨æˆ·è¾“å…¥çš„ IP
           sed -i "s/192.168.10.1/${{ inputs.ipaddr }}/g" "$CONFIG_PATH"
           
           # åœ¨è®¾ç½® IP çš„ä»£ç è¡Œåï¼ŒåŠ¨æ€æ’å…¥ç½‘å…³å’Œ DNS è®¾ç½®
           sed -i "/uci set network.lan.ipaddr/a \        uci set network.lan.gateway='${{ inputs.gateway }}'\n        uci set network.lan.dns='${{ inputs.gateway }}'" "$CONFIG_PATH"
        else
           echo "æ¨¡å¼ï¼šDHCP / é»˜è®¤æ¨¡å¼ (ä¸»è·¯ç”±)"
           # ä¿æŒåŸè„šæœ¬é€»è¾‘ï¼šå•ç½‘å£è‡ªåŠ¨ DHCPï¼Œå¤šç½‘å£ä¿æŒ 192.168.10.1
        fi

        # 3. æ›¿æ¢è„šæœ¬æœ«å°¾çš„æè¿°ä¿¡æ¯
        sed -i "s/VERXXXX/${{ env.VERSION }}/g" "$CONFIG_PATH"
        
        echo "âœ… é…ç½®ä¿®æ”¹å®Œæˆï¼Œè¾“å‡ºé¢„è§ˆï¼š"
        cat "$CONFIG_PATH"

    - name: â¬ å®‰è£…ä¾èµ–
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential libncurses5-dev zstd curl unzip tree

    - name: â¬ ä¸‹è½½ ImageBuilder
      run: |
        BUILD_VER="${{ inputs.build_version }}"
        if [ "$BUILD_VER" = "latest" ]; then
          URL="https://fw0.koolcenter.com/iStoreOS/ib/armsr/istoreos-imagebuilder-armsr-armv8.Linux-x86_64.tar.zst"
        else
          URL="https://github.com/${{ github.repository }}/releases/download/iStoreOS-Imagebuilder/${BUILD_VER}-istoreos-imagebuilder-armsr-armv8.Linux-x86_64.tar.zst"
        fi
        curl -Lf -o imagebuilder.tar.zst "$URL"
        tar --use-compress-program=unzstd -xvf imagebuilder.tar.zst
        mv istoreos-imagebuilder-* imagebuilder

    - name: â¬ å¤åˆ¶å¹¶è®¾ç½®å¿…å¤‡æ–‡ä»¶
      run: |
        # âš ï¸ ç¡®ä¿è¿™é‡Œå¤åˆ¶äº† repositories.conf
        cp arm64/{build_config.sh,Makefile} imagebuilder/
        # å¦‚æœä½ çš„ repositories.conf åœ¨æ ¹ç›®å½•æˆ– arm64 ç›®å½•ä¸‹ï¼Œè¯·ç¡®ä¿è·¯å¾„æ­£ç¡®
        [ -f "repositories.conf" ] && cp repositories.conf imagebuilder/ || cp arm64/repositories.conf imagebuilder/
        
        cp shell/{prepare-packages.sh,custom-packages.sh} imagebuilder/
        find files/packages/ -name "*.ipk" -exec cp {} imagebuilder/packages/ \;
        
        mkdir -p imagebuilder/files/etc/{uci-defaults,banner1}
        cp files/etc/uci-defaults/99-custom.sh imagebuilder/files/etc/uci-defaults/
        cp files/etc/banner imagebuilder/files/etc/banner1/
        cp files/etc/rc.local imagebuilder/files/etc/
        mkdir -p imagebuilder/files/etc/opkg
        cp -r files/customfeeds/* imagebuilder/files/etc/opkg/ 2>/dev/null || true
        # éªŒè¯ä¿¡æ¯
        ls -l imagebuilder/files/etc/opkg/customfeeds.conf && echo "å·²æ‹·è´ customfeeds.conf"

        cd imagebuilder
        sed -i 's/# CONFIG_TARGET_ROOTFS_TARGZ is not set/CONFIG_TARGET_ROOTFS_TARGZ=y/' .config
        sed -i "s|CONFIG_TARGET_ROOTFS_SQUASHFS=.*|# CONFIG_TARGET_ROOTFS_SQUASHFS is not set|g" .config
        sed -i "s|CONFIG_TARGET_IMAGES_GZIP=.*|# CONFIG_TARGET_IMAGES_GZIP is not set|g" .config

    - name: âš™ï¸ åŠ¨æ€è·å– Kmod å“ˆå¸Œå¹¶æ›´æ–°é…ç½®
      run: |
        BUILD_VER="${{ env.VERSION }}"
        # ç¡®ä¿åŸºç¡€è·¯å¾„æ­£ç¡®ï¼ˆARM æ¶æ„è·¯å¾„ï¼‰
        BASE_URL="https://downloads.openwrt.org/releases/${BUILD_VER}/targets/armsr/armv8/kmods/"
        
        echo "æ­£åœ¨ä» $BASE_URL è·å–æœ€æ–°çš„å†…æ ¸å“ˆå¸Œ..."
        KMOD_DIR=$(curl -sL $BASE_URL | grep -oE "[0-9.-]+-[a-f0-9]{32}" | head -n 1)
        
        if [ -n "$KMOD_DIR" ]; then
          FULL_KMOD_URL="${BASE_URL}${KMOD_DIR}"
          echo "âœ… æˆåŠŸåŒ¹é… kmods è·¯å¾„: $FULL_KMOD_URL"
          
          # 1. æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          TARGET_CONF="imagebuilder/repositories.conf"
          if [ ! -f "$TARGET_CONF" ]; then
            echo "âŒ é”™è¯¯: $TARGET_CONF ä¸å­˜åœ¨ï¼Œè¯·æ£€æŸ¥ 'å¤åˆ¶å¿…å¤‡æ–‡ä»¶' æ­¥éª¤"
            exit 1
          fi

          # 2. æ›¿æ¢ç‰ˆæœ¬å· (æ”¯æŒå ä½ç¬¦ VERSION_PLACEHOLDER æˆ–ç¡¬ç¼–ç çš„ 24.10.4)
          sed -i "s|VERSION_PLACEHOLDER|${BUILD_VER}|g" "$TARGET_CONF"
          sed -i "s|24.10.4|${BUILD_VER}|g" "$TARGET_CONF"
          
          # 3. æ›¿æ¢ Kmod æ•´è¡Œ (æœ€ç¨³å¦¥ï¼šç›´æ¥åŒ¹é…åŒ…å« openwrt_kmods çš„è¡Œå¹¶é‡å†™)
          sed -i "s|^src/gz openwrt_kmods.*|src/gz openwrt_kmods $FULL_KMOD_URL|g" "$TARGET_CONF"
          
          echo "--- æ›´æ–°åçš„é…ç½®æ–‡ä»¶å†…å®¹ (é¢„è§ˆ) ---"
          cat "$TARGET_CONF"
        else
          echo "âŒ æ— æ³•è·å– Kmod å“ˆå¸Œï¼Œè¯·æ£€æŸ¥å®˜æ–¹æºæ˜¯å¦å­˜åœ¨è¯¥ç‰ˆæœ¬: $BASE_URL"
          exit 1
        fi

    - name: ğŸ§± æ„å»ºiStoreOS-rootfs
      working-directory: ./imagebuilder
      run: bash ./build_config.sh

    - name: ğŸš€ ä¸Šä¼ åˆ° Release
      uses: softprops/action-gh-release@v2.2.1
      with:
        tag_name: iStoreOS-ARM-${{ env.VERSION }}-RELEASE-${{ inputs.network_settings }}
        body: |

          ğŸ“¡ ------------------------------è·¯ç”±å™¨åå°ä¿¡æ¯------------------------------
          
          ğŸ“Œ ç‰ˆæœ¬ï¼š iStoreOS-ARM-${{ env.VERSION }}

          ğŸ§  å†…æ ¸ï¼š Please Login to iStoreOS â†’ System â†’ Amlogic Service â†’ Replace the Kernel
          
          ğŸ§© é›†æˆï¼š åŒ…å«äº†åŸºç¡€ç³»ç»Ÿç»„ä»¶ã€é©±åŠ¨ã€ç½‘ç»œå·¥å…·ã€å®¹å™¨æ”¯æŒã€LuCIç•Œé¢åŠæ’ä»¶ç­‰
          
          ğŸ‘¤ ç”¨æˆ·åï¼š root
          
          ğŸ”’ å¯†ç ï¼š æ— 
          
          ğŸŒ åˆå§‹IPï¼š ${{ inputs.ipaddr }}

          
        files: imagebuilder/bin/targets/armsr/armv8/*generic-rootfs.tar.gz
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
